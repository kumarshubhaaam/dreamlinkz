
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Stream</title>
  <style>
    body {
      margin: 0;
      font-family: 'Inter', sans-serif;
      background: #0a0a0a;
      color: white;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      text-align: center;
    }
    .card, .verify-lock {
      background-color: #1c1c1c;
      padding: 2rem;
      border-radius: 1rem;
      margin: 1rem;
      max-width: 800px;
      width: 100%;
      box-shadow: 0 0 12px rgba(0, 255, 226, 0.2);
    }
    .iframe-container {
      position: relative;
      padding-bottom: 56.25%;
      height: 0;
      overflow: hidden;
    }
    .iframe-container iframe {
      position: absolute;
      width: 100%;
      height: 100%;
      border: none;
      border-radius: 0.5rem;
    }
    .verify-btn {
      margin-top: 1rem;
      padding: 12px 24px;
      font-size: 1rem;
      background: linear-gradient(to right, #ff6a00, #ff9472);
      color: white;
      border: none;
      border-radius: 2rem;
      cursor: pointer;
      font-weight: bold;
    }
  </style>
</head>
<body>

<div id="verificationLock" class="verify-lock" style="display: none;">
  <h2>Verification Required</h2>
  <p>This token is invalid, expired, or from another device.</p>
  <button class="verify-btn" onclick="window.location.href='verify.html'">Verify Now</button>
</div>

<div class="card" id="streamCard" style="display: none;">
  <h2 id="videoTitle">Streaming...</h2>
  <div class="iframe-container">
    <iframe id="videoPlayer" allowfullscreen></iframe>
  </div>
</div>

<script>
  const urlParams = new URLSearchParams(window.location.search);
  const streamUrl = urlParams.get('url');
  const title = urlParams.get('title') || "Streaming...";
  const token = urlParams.get('token');

  function generateFingerprint() {
    return btoa(navigator.userAgent + screen.width + screen.height);
  }

  function openDB() {
    return new Promise((resolve, reject) => {
      const request = indexedDB.open('VerificationDB', 1);
      request.onupgradeneeded = function (e) {
        const db = e.target.result;
        if (!db.objectStoreNames.contains('AccessStore')) {
          db.createObjectStore('AccessStore', { keyPath: 'id' });
        }
      };
      request.onsuccess = () => resolve(request.result);
      request.onerror = () => reject("IndexedDB failed to open.");
    });
  }

  async function getAccessData() {
    const db = await openDB();
    return new Promise((resolve, reject) => {
      const tx = db.transaction('AccessStore', 'readonly');
      const store = tx.objectStore('AccessStore');
      const request = store.get('user-access');
      request.onsuccess = () => resolve(request.result);
      request.onerror = () => reject("Failed to read access data.");
      tx.oncomplete = () => db.close();
    });
  }

  getAccessData().then(data => {
    const now = Date.now();
    const fingerprint = generateFingerprint();

    if (
      data &&
      data.token === token &&
      data.fingerprint === fingerprint &&
      now < data.expires
    ) {
      document.getElementById("videoTitle").innerText = decodeURIComponent(title);
      document.getElementById("videoPlayer").src = streamUrl;
      document.getElementById("streamCard").style.display = "block";
    } else {
      document.getElementById("verificationLock").style.display = "block";
    }
  }).catch(() => {
    document.getElementById("verificationLock").style.display = "block";
  });
</script>

</body>
</html>
