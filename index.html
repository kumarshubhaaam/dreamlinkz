
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta name="theme-color" content="#1c1c1c">
  <title>Dream Linkz</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    body {
      background-color: #0a0a0a;
      color: white;
      font-family: 'Inter', sans-serif;
      margin: 0;
      min-height: 100vh;
    }
    .section-heading {
      text-align: center;
      font-size: 2.5rem;
      color: white;
      font-weight: bold;
      margin: 2rem auto 1rem;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 2rem;
      padding: 0 2rem;
    }
    .card {
      background-color: #1c1c1c;
      padding: 1rem;
      border-radius: 0.75rem;
      text-align: center;
      border: 2px solid transparent;
      transition: transform 0.4s, box-shadow 0.4s, opacity 0.4s;
    }
    .card img {
      width: 100%;
      height: 180px;
      object-fit: fill;
      border-radius: 0.5rem;
      margin-bottom: 1rem;
    }
    .card h3 {
      font-size: 1.2rem;
      margin-bottom: 0.8rem;
    }
    .card button {
      padding: 0.8rem;
      width: 100%;
      font-size: 1rem;
      font-weight: bold;
      background: linear-gradient(to right, #00ffd2, #00ffd2);
      color: black;
      border: none;
      border-radius: 0.5rem;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <h2 class="section-heading">All Videos</h2>
  <section class="grid" id="postGrid"></section>

  <script>
    const sheetID = '10FX0gA-mYFTQgR22yxCD8NuZ7QUIQ2iUW4pjmc9glIM';
    const sheetName = 'Sheet1';
    const query = encodeURIComponent('SELECT A, B, C');
    const url = `https://docs.google.com/spreadsheets/d/${sheetID}/gviz/tq?sheet=${sheetName}&tq=${query}`;

    fetch(url)
      .then(res => res.text())
      .then(rep => {
        const json = JSON.parse(rep.substring(47).slice(0, -2));
        const data = json.table.rows;
        const posts = data.map((row, i) => ({
          title: row.c[0]?.v || 'Untitled',
          imageUrl: row.c[1]?.v || '',
          watchUrl: row.c[2]?.v || '#'
        }));
        renderPosts(posts);
      });

    function renderPosts(posts) {
      const grid = document.getElementById('postGrid');
      grid.innerHTML = '';
      posts.forEach(post => {
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
          <img src="${post.imageUrl}" alt="${post.title}" />
          <h3>${post.title}</h3>
          <button onclick="handleWatchClick('${encodeURIComponent(post.watchUrl)}', '${encodeURIComponent(post.title)}')">Watch</button>
        `;
        grid.appendChild(card);
      });
    }

    function generateFingerprint() {
      return btoa(navigator.userAgent + screen.width + screen.height);
    }

    function openDB() {
      return new Promise((resolve, reject) => {
        const request = indexedDB.open('VerificationDB', 1);
        request.onupgradeneeded = function (e) {
          const db = e.target.result;
          if (!db.objectStoreNames.contains('AccessStore')) {
            db.createObjectStore('AccessStore', { keyPath: 'id' });
          }
        };
        request.onsuccess = () => resolve(request.result);
        request.onerror = () => reject("Failed to open DB");
      });
    }

    async function getAccessData() {
      const db = await openDB();
      return new Promise((resolve, reject) => {
        const tx = db.transaction('AccessStore', 'readonly');
        const store = tx.objectStore('AccessStore');
        const req = store.get('user-access');
        req.onsuccess = () => resolve(req.result);
        req.onerror = () => reject("Failed to read DB");
        tx.oncomplete = () => db.close();
      });
    }

    async function handleWatchClick(encodedUrl, encodedTitle) {
      const token = null;
      const fingerprint = generateFingerprint();
      const now = Date.now();

      try {
        const data = await getAccessData();
        if (
          data &&
          data.fingerprint === fingerprint &&
          now < data.expires
        ) {
          const streamURL = `stream.html?url=${encodedUrl}&title=${encodedTitle}&token=${data.token}`;
          window.open(streamURL, '_blank');
        } else {
          window.location.href = `verify.html?url=${encodedUrl}&title=${encodedTitle}`;
        }
      } catch {
        window.location.href = `verify.html?url=${encodedUrl}&title=${encodedTitle}`;
      }
    }
  </script>
</body>
</html>
